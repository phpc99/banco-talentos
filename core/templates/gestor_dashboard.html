{% extends "base.html" %}
{% load static %}

{% block title %}Painel do Gestor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/gestor_dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/alerta.css' %}">
{% endblock %}

{% block content %}

<div class="dashboard-body">

    <div class="dashboard-wrapper">

        <header class="dashboard-header">
            <div>
                <h1 class="dashboard-title">Painel do Gestor</h1>
                <p class="dashboard-subtitle">
                    Visualize, filtre e gerencie as candidaturas cadastradas.
                </p>
            </div>

            <div class="dashboard-actions">
                <a href="{% url 'entrevistas-lista' %}" class="btn-primary">
                    Ir para Entrevistas
                </a>
            </div>
        </header>

        <!-- Mensagem de sucesso -->
        {% if messages %}
            <div id="mensagens-container" class="alert-sucesso alert-floating">
                {% for message in messages %}
                    <img
                        src="{% static 'img/checked.png' %}"
                        alt="Sucesso"
                        class="icone-sucesso"
                    />
                    <span>{{ message }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <!-- FILTROS -->
        <section class="card filters-card">
            <h2 class="card-title">Filtros</h2>

            <form method="get" class="filters-form">
                <div class="filters-row">

                    <div class="form-group">
                        <label for="filtro_estado">Estado</label>
                        <select id="filtro_estado" name="estado">
                            <option value="">Todos</option>
                            {% for sigla, nome in opcoes_estados %}
                                <option value="{{ sigla }}" {% if sigla == estado_selecionado %}selected{% endif %}>
                                    {{ nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="filtro_formacao">Formação</label>
                        <select id="filtro_formacao" name="formacao">
                            <option value="">Todas</option>
                            {% for codigo, rotulo in opcoes_formacoes %}
                                <option value="{{ codigo }}" {% if codigo == formacao_selecionada %}selected{% endif %}>
                                    {{ rotulo }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="filtro_area">Área</label>
                        <select id="filtro_area" name="area">
                            <option value="">Todas</option>
                            {% for codigo, rotulo in opcoes_areas %}
                                <option value="{{ codigo }}" {% if codigo == area_selecionada %}selected{% endif %}>
                                    {{ rotulo }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

                <div class="filters-actions">
                    <button type="submit" class="btn-primary">Aplicar filtros</button>
                    <a href="{% url 'gestor-dashboard' %}" class="btn-link" style="margin-top: 8px;">Limpar filtros</a>
                </div>
            </form>
        </section>

        <!-- TABELA -->
        <section class="card table-card">

            <div class="table-header-row">
                <div>
                    <h2 class="card-title">Lista de candidatos</h2>
                    <p class="card-subtitle">
                        Foram encontradas <strong>{{ total_candidatos_filtrados }}</strong> candidaturas.
                    </p>
                </div>
            </div>

            {% if candidatos %}
                <div class="table-wrapper">
                    <table class="data-table">

                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Email</th>
                                <th>Estado</th>
                                <th>Cidade</th>
                                <th>Formação</th>
                                <th>Área</th>
                                <th>Currículo</th>
                                <th>Foto</th>
                                <th>Ações</th>
                                <th>Anotações</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for candidato in candidatos %}
                                <tr>
                                    <td>{{ candidato.id }}</td>
                                    <td>{{ candidato.nome }}</td>

                                    <td>
                                        <form method="post" action="{% url 'atualizar-status' candidato.id %}">
                                            {% csrf_token %}

                                            <input type="hidden" name="page" value="{{ page_obj.number }}">
                                            <input type="hidden" name="estado" value="{{ estado_selecionado }}">
                                            <input type="hidden" name="formacao" value="{{ formacao_selecionada }}">
                                            <input type="hidden" name="area" value="{{ area_selecionada }}">

                                            <select name="status">
                                                {% for code, label in candidato.STATUS_CHOICES %}
                                                    <option value="{{ code }}" {% if candidato.status == code %}selected{% endif %}>
                                                        {{ label }}
                                                    </option>
                                                {% endfor %}
                                            </select>

                                            <button type="submit" class="btn-secondary">Salvar</button>
                                        </form>
                                    </td>

                                    <td>{{ candidato.email }}</td>
                                    <td>{{ candidato.estado }}</td>
                                    <td>{{ candidato.cidade }}</td>
                                    <td>{{ candidato.get_formacao_display }}</td>
                                    <td>{{ candidato.get_area_display }}</td>

                                    <td>
                                        {% if candidato.curriculo %}
                                            <a href="{{ candidato.curriculo.url }}" target="_blank" class="link-table">
                                                Ver currículo
                                            </a>
                                        {% else %}
                                            <span class="badge badge-muted">Não enviado</span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {% if candidato.foto %}
                                            <img src="{{ candidato.foto.url }}" width="60" height="60">
                                        {% else %}
                                            <span class="badge badge-muted">Não enviada</span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        <button
                                            type="button"
                                            class="btn-link-danger"
                                            onclick="abrirModalExcluir('{{ candidato.id }}', '{{ candidato.nome }}')"
                                        >
                                            Excluir
                                        </button>
                                    </td>

                                    <!-- MODAL DE CONFIRMAÇÃO DE EXCLUSÃO -->
                                    <div id="modal-excluir" class="modal-overlay hidden">

                                        <div class="modal-box">
                                            <h2 class="modal-title">Confirmar exclusão</h2>

                                            <p class="modal-text" id="modal-texto">
                                                <!-- texto preenchido via JS -->
                                            </p>

                                            <form method="post" id="form-excluir">
                                                {% csrf_token %}
                                                <div class="modal-actions">
                                                    <button type="submit" class="btn-link-danger">
                                                        Sim, excluir
                                                    </button>

                                                    <button type="button" class="btn-secondary" onclick="fecharModalExcluir()">
                                                        Cancelar
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                    </div>

                                    <td>
                                        <form method="post" action="{% url 'atualizar-anotacoes' candidato.id %}">
                                        {% csrf_token %}

                                        <input type="hidden" name="page" value="{{ page_obj.number }}">
                                        <input type="hidden" name="estado" value="{{ estado_selecionado }}">
                                        <input type="hidden" name="formacao" value="{{ formacao_selecionada }}">
                                        <input type="hidden" name="area" value="{{ area_selecionada }}">

                                        <textarea name="anotacoes" rows="3" class="textarea-anotacoes">{{ candidato.anotacoes|default_if_none:"" }}</textarea>
                                        <button type="submit" class="btn-secondary">Salvar</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>

                    </table>
                </div>

                <!-- PAGINATOR -->
                {% if candidatos.has_other_pages %}
                    <div class="pagination">
                        {% if candidatos.has_previous %}
                            <a class="pagination-link" href="?page={{ candidatos.previous_page_number }}">← Anterior</a>
                        {% endif %}

                        <span class="pagination-info">
                            Página {{ candidatos.number }} de {{ candidatos.paginator.num_pages }}
                        </span>

                        {% if candidatos.has_next %}
                            <a class="pagination-link" href="?page={{ candidatos.next_page_number }}">Próxima →</a>
                        {% endif %}
                    </div>
                {% endif %}

            {% else %}
                <p class="sem-resultados">
                    Não há candidatos cadastrados com os filtros selecionados.
                </p>
            {% endif %}
        </section>

        <!-- DADOS DOS GRÁFICOS -->
        {{ chart_area|json_script:"chart-area-data" }}
        {{ chart_formacao|json_script:"chart-formacao-data" }}
        {{ chart_estado|json_script:"chart-estado-data" }}

        <section class="charts-section">
            <h2 class="card-title">Gráficos (com base nos filtros atuais)</h2>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Candidatos por área</h3>
                        <div class="chart-toggle">
                            <button class="btn-chip" onclick="mudarTipo('area','bar')">Barras</button>
                            <button class="btn-chip" onclick="mudarTipo('area','pie')">Pizza</button>
                        </div>
                    </div>

                    <div class="chart-body">
                        <canvas id="graficoArea"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Candidatos por formação</h3>
                        <div class="chart-toggle">
                            <button class="btn-chip" onclick="mudarTipo('formacao','bar')">Barras</button>
                            <button class="btn-chip" onclick="mudarTipo('formacao','pie')">Pizza</button>
                        </div>
                    </div>

                    <div class="chart-body">
                        <canvas id="graficoFormacao"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Candidatos por estado</h3>
                        <div class="chart-toggle">
                            <button class="btn-chip" onclick="mudarTipo('estado','bar')">Barras</button>
                            <button class="btn-chip" onclick="mudarTipo('estado','pie')">Pizza</button>
                        </div>
                    </div>

                    <div class="chart-body">
                        <canvas id="graficoEstado"></canvas>
                    </div>
                </div>
            </div>
        </section>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/graficos.js' %}"></script>
<script src="{% static 'js/alerta.js' %}"></script>
<script src="{% static 'js/modal_excluir.js' %}"></script>

{% endblock %}